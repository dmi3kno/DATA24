{
  "hash": "082e37f2afde3bcb4489477ac7394cbe",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Wrangling\"\nformat: html\nengine: python3\n---\n\n\n\n\n## Data\n\n::: {#setup .cell execution_count=1}\n``` {.python .cell-code}\nimport polars as pl\nimport polars.selectors as cs\nfrom plotnine import *\nfrom great_tables import GT\ntheme_set(theme_linedraw())\n```\n:::\n\n\n# Part I. Basics\n\n::: {#5c1456bf .cell execution_count=2}\n``` {.python .cell-code}\n# indoor air pollution\nhhap_deaths = pl.read_csv(\"hhap/hhap_deaths.csv\")\nclean_fuels = pl.read_csv(\"hhap/clean_fuels_cooking.csv\")\nfuel_types = pl.read_csv(\"hhap/cooking_by_fuel_type.csv\")\n```\n:::\n\n\n## Data Overview\n\nPolars data frames can be conveniently previewed with\n\n::: {#0aa2e21e .cell execution_count=3}\n``` {.python .cell-code}\nhhap_deaths\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (10_800, 6)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th><th>year</th><th>cause_of_death</th><th>deaths</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td><td>str</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;All causes&quot;</td><td>0.0</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;Acute lower respiratory infect…</td><td>0.0</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;Trachea, bronchus, lung cancer…</td><td>0.0</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;Ischaemic heart disease&quot;</td><td>0.0</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;Stroke&quot;</td><td>0.0</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;BOL&quot;</td><td>&quot;Bolivia (Plurinational State o…</td><td>2019</td><td>&quot;Trachea, bronchus, lung cancer…</td><td>98.72</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;GNB&quot;</td><td>&quot;Guinea-Bissau&quot;</td><td>2019</td><td>&quot;Chronic obstructive pulmonary …</td><td>98.88</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;CIV&quot;</td><td>&quot;Cote d&#x27;Ivoire&quot;</td><td>2019</td><td>&quot;Chronic obstructive pulmonary …</td><td>990.6</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;TUR&quot;</td><td>&quot;Türkiye&quot;</td><td>2019</td><td>&quot;Chronic obstructive pulmonary …</td><td>997.6</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;UZB&quot;</td><td>&quot;Uzbekistan&quot;</td><td>2019</td><td>&quot;All causes&quot;</td><td>9982.0</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nBy default this shows 5 first and 5 last rows of the data. Rows are often called observations or records and columns are called variables or features. If you want to see a few more observations off the top of the dataset, you can call\n\n::: {#2990d365 .cell execution_count=4}\n``` {.python .cell-code}\n(hhap_deaths\n    .head(10))\n```\n\n::: {.cell-output .cell-output-display execution_count=4}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (10, 6)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th><th>year</th><th>cause_of_death</th><th>deaths</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td><td>str</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;All causes&quot;</td><td>0.0</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;Acute lower respiratory infect…</td><td>0.0</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;Trachea, bronchus, lung cancer…</td><td>0.0</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;Ischaemic heart disease&quot;</td><td>0.0</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;Stroke&quot;</td><td>0.0</td></tr><tr><td>&quot;Americas&quot;</td><td>&quot;ATG&quot;</td><td>&quot;Antigua and Barbuda&quot;</td><td>2010</td><td>&quot;Chronic obstructive pulmonary …</td><td>0.0</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;AUS&quot;</td><td>&quot;Australia&quot;</td><td>2010</td><td>&quot;All causes&quot;</td><td>0.0</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;AUS&quot;</td><td>&quot;Australia&quot;</td><td>2010</td><td>&quot;Acute lower respiratory infect…</td><td>0.0</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;AUS&quot;</td><td>&quot;Australia&quot;</td><td>2010</td><td>&quot;Trachea, bronchus, lung cancer…</td><td>0.0</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;AUS&quot;</td><td>&quot;Australia&quot;</td><td>2010</td><td>&quot;Ischaemic heart disease&quot;</td><td>0.0</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nWhen the number of columns is large, this may not be the most convenient way of getting an overview of the data. Alternative representation can be produced using glimpse, which shows the same data in horizontal (textual) form, i.e. every variable now occupies one row. \n\n::: {#a52651ba .cell execution_count=5}\n``` {.python .cell-code}\n(clean_fuels\n    .glimpse())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 6402\nColumns: 6\n$ region                       <str> 'Africa', 'Western Pacific', 'Western Pacific', 'Western Pacific', 'Western Pacific', 'Africa', 'Western Pacific', 'Africa', 'Western Pacific', 'Western Pacific'\n$ country_code                 <str> 'SSD', 'NIU', 'TKL', 'COK', 'PLW', 'STP', 'FSM', 'BDI', 'NRU', 'TUV'\n$ country                      <str> 'South Sudan', 'Niue', 'Tokelau', 'Cook Islands', 'Palau', 'Sao Tome and Principe', 'Micronesia (Federated States of)', 'Burundi', 'Nauru', 'Tuvalu'\n$ year                         <i64> 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022\n$ pop_clean_fuels_cooking_mln  <f64> 0.0, 0.002, 0.0004, 0.013, 0.007, 0.009, 0.014, 0.013, 0.011, 0.009\n$ prop_clean_fuels_cooking_pct <f64> 0.0, 98.5, 28.3, 72.7, 29.45, 4.1, 13.2, 0.1, 100.0, 75.2\n\n```\n:::\n:::\n\n\nWe can also look at the table of statistical summaries for our data\n\n::: {#4394c7cb .cell execution_count=6}\n``` {.python .cell-code}\n(clean_fuels\n    .describe())\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (9, 7)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>statistic</th><th>region</th><th>country_code</th><th>country</th><th>year</th><th>pop_clean_fuels_cooking_mln</th><th>prop_clean_fuels_cooking_pct</th></tr><tr><td>str</td><td>str</td><td>str</td><td>str</td><td>f64</td><td>f64</td><td>f64</td></tr></thead><tbody><tr><td>&quot;count&quot;</td><td>&quot;6402&quot;</td><td>&quot;6402&quot;</td><td>&quot;6402&quot;</td><td>6402.0</td><td>6402.0</td><td>6402.0</td></tr><tr><td>&quot;null_count&quot;</td><td>&quot;0&quot;</td><td>&quot;0&quot;</td><td>&quot;0&quot;</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><td>&quot;mean&quot;</td><td>null</td><td>null</td><td>null</td><td>2006.0</td><td>19.29797</td><td>61.080069</td></tr><tr><td>&quot;std&quot;</td><td>null</td><td>null</td><td>null</td><td>9.522648</td><td>73.100935</td><td>39.952764</td></tr><tr><td>&quot;min&quot;</td><td>&quot;Africa&quot;</td><td>&quot;AFG&quot;</td><td>&quot;Afghanistan&quot;</td><td>1990.0</td><td>0.0</td><td>0.0</td></tr><tr><td>&quot;25%&quot;</td><td>null</td><td>null</td><td>null</td><td>1998.0</td><td>0.23</td><td>16.6</td></tr><tr><td>&quot;50%&quot;</td><td>null</td><td>null</td><td>null</td><td>2006.0</td><td>2.24</td><td>78.0</td></tr><tr><td>&quot;75%&quot;</td><td>null</td><td>null</td><td>null</td><td>2014.0</td><td>10.24</td><td>100.0</td></tr><tr><td>&quot;max&quot;</td><td>&quot;Western Pacific&quot;</td><td>&quot;ZWE&quot;</td><td>&quot;Zimbabwe&quot;</td><td>2022.0</td><td>1257.0</td><td>100.0</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\n# select/exclude/drop and filter\n\nOne of the most common things done in data analysis is selecting particular variables. \n\n::: {#67bf404b .cell execution_count=7}\n``` {.python .cell-code}\n(clean_fuels\n    .select(pl.col(\"country\"))\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (6_402, 1)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>country</th></tr><tr><td>str</td></tr></thead><tbody><tr><td>&quot;South Sudan&quot;</td></tr><tr><td>&quot;Niue&quot;</td></tr><tr><td>&quot;Tokelau&quot;</td></tr><tr><td>&quot;Cook Islands&quot;</td></tr><tr><td>&quot;Palau&quot;</td></tr><tr><td>&hellip;</td></tr><tr><td>&quot;Austria&quot;</td></tr><tr><td>&quot;Germany&quot;</td></tr><tr><td>&quot;Sweden&quot;</td></tr><tr><td>&quot;Portugal&quot;</td></tr><tr><td>&quot;India&quot;</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nAs you can see the column name is wrapped into the expression for column `pl.col()`. The wrapper can sometimes be skipped, as the case is here. The `select()` will \"wrap\" the strings you provide into the `pl.col()` wrapper interpreting them as column names \n\n::: {#73dcdc62 .cell execution_count=8}\n``` {.python .cell-code}\n(clean_fuels\n    .select(\"country_code\", \"country\")\n)\n\n(clean_fuels\n    .select(pl.col(\"country_code\"), pl.col(\"country\"))\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=8}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (6_402, 2)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>country_code</th><th>country</th></tr><tr><td>str</td><td>str</td></tr></thead><tbody><tr><td>&quot;SSD&quot;</td><td>&quot;South Sudan&quot;</td></tr><tr><td>&quot;NIU&quot;</td><td>&quot;Niue&quot;</td></tr><tr><td>&quot;TKL&quot;</td><td>&quot;Tokelau&quot;</td></tr><tr><td>&quot;COK&quot;</td><td>&quot;Cook Islands&quot;</td></tr><tr><td>&quot;PLW&quot;</td><td>&quot;Palau&quot;</td></tr><tr><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;AUT&quot;</td><td>&quot;Austria&quot;</td></tr><tr><td>&quot;DEU&quot;</td><td>&quot;Germany&quot;</td></tr><tr><td>&quot;SWE&quot;</td><td>&quot;Sweden&quot;</td></tr><tr><td>&quot;PRT&quot;</td><td>&quot;Portugal&quot;</td></tr><tr><td>&quot;IND&quot;</td><td>&quot;India&quot;</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nColumn names wrapped into `pl.col()` represent the simplest kind of *expressions*. In polars we create expressions and evaluate them in the context of the data. Expressions taken in isolation don't do anything, they need to be considered in the context of the data to return some data. This line of code does not do anything. It just returns an expression:\n\n::: {#1083fd7d .cell execution_count=9}\n``` {.python .cell-code}\npl.col(\"country_code\")\n```\n\n::: {.cell-output .cell-output-display execution_count=9}\n```{=html}\ncol(\"country_code\")\n```\n:::\n:::\n\n\nBut when we evaluate in the context of the `clean_fuels` dataframe it will will return a column of country codes\n\n::: {#6562e68b .cell execution_count=10}\n``` {.python .cell-code}\n(clean_fuels\n    .select(pl.col(\"country_code\"))\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=10}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (6_402, 1)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>country_code</th></tr><tr><td>str</td></tr></thead><tbody><tr><td>&quot;SSD&quot;</td></tr><tr><td>&quot;NIU&quot;</td></tr><tr><td>&quot;TKL&quot;</td></tr><tr><td>&quot;COK&quot;</td></tr><tr><td>&quot;PLW&quot;</td></tr><tr><td>&hellip;</td></tr><tr><td>&quot;AUT&quot;</td></tr><tr><td>&quot;DEU&quot;</td></tr><tr><td>&quot;SWE&quot;</td></tr><tr><td>&quot;PRT&quot;</td></tr><tr><td>&quot;IND&quot;</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nIn this case, `select()` statement provides an evaluation environment. There are several commands in `polars` which provide an environment for evaluating data expressions and `select()` is the simplest one of them. It is really versatile, but at this time we will only consider the simplest usecase: extracting columns from the dataframe using expressions.\n\nUsing column name wrapped in `pl.col()` as an expression-starter is a very common approach in polars. We will use it quite often to build powerful expressions tranforming columns in polars. Expressions can used to refer to multiple columns at once. For example, here we are making an expression which will refer to all columns other than country and region.\n\n::: {#7b23b7ea .cell execution_count=11}\n``` {.python .cell-code}\n(clean_fuels\n    .select(pl.all().exclude(\"country\", \"region\"))\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=11}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (6_402, 4)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>country_code</th><th>year</th><th>pop_clean_fuels_cooking_mln</th><th>prop_clean_fuels_cooking_pct</th></tr><tr><td>str</td><td>i64</td><td>f64</td><td>f64</td></tr></thead><tbody><tr><td>&quot;SSD&quot;</td><td>2022</td><td>0.0</td><td>0.0</td></tr><tr><td>&quot;NIU&quot;</td><td>2022</td><td>0.002</td><td>98.5</td></tr><tr><td>&quot;TKL&quot;</td><td>2022</td><td>0.0004</td><td>28.3</td></tr><tr><td>&quot;COK&quot;</td><td>2022</td><td>0.013</td><td>72.7</td></tr><tr><td>&quot;PLW&quot;</td><td>2022</td><td>0.007</td><td>29.45</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;AUT&quot;</td><td>1990</td><td>7.72</td><td>100.0</td></tr><tr><td>&quot;DEU&quot;</td><td>1990</td><td>79.12</td><td>100.0</td></tr><tr><td>&quot;SWE&quot;</td><td>1990</td><td>8.57</td><td>100.0</td></tr><tr><td>&quot;PRT&quot;</td><td>1990</td><td>9.95</td><td>100.0</td></tr><tr><td>&quot;IND&quot;</td><td>1990</td><td>96.58</td><td>11.1</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\n`pl.all()` refers to all columns in the evaluation environment and it gets further refined by method chaining excluding `country` and `region`.\n\nSelecting columns is a very common operation. It is so important and used so often, that there's a special class of methods designed specifically for this purpose, situated in `polars.selectors`, commonly aliased as `cs`. Have a look at the `polars` [documentation for selectors](https://docs.pola.rs/api/python/stable/reference/selectors.html)\n\nAmong the most useful selectors are, of course, selectors by name and column number (for which we might not really need selectors, because those can be picked up with `pl.col()` and `pl.nth()`). \n\n::: {#610abd59 .cell execution_count=12}\n``` {.python .cell-code}\nimport polars.selectors as cs\n\n(clean_fuels\n    .select(cs.by_name(\"region\", \"country\"))\n)\n\n# note python is 0-based\n(clean_fuels\n    .select(cs.by_index(0,2,5))\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=12}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (6_402, 3)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country</th><th>prop_clean_fuels_cooking_pct</th></tr><tr><td>str</td><td>str</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Africa&quot;</td><td>&quot;South Sudan&quot;</td><td>0.0</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;Niue&quot;</td><td>98.5</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;Tokelau&quot;</td><td>28.3</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;Cook Islands&quot;</td><td>72.7</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;Palau&quot;</td><td>29.45</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;Austria&quot;</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;Germany&quot;</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;Sweden&quot;</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;Portugal&quot;</td><td>100.0</td></tr><tr><td>&quot;South-East Asia&quot;</td><td>&quot;India&quot;</td><td>11.1</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nBut perhaps more unique and useful selectors are `cs.first()` and `cs.last()`, as well as a collection of selectors for each of the data types, such as `cs.numeric()`. The selector can be negated with `~` sign, so that `~cs.numeric()` means non-numeric columns.\n\n::: {#9fa26f36 .cell execution_count=13}\n``` {.python .cell-code}\n(clean_fuels\n    .select(cs.first())\n)\n\n# not first\n(clean_fuels\n    .select(~cs.first())\n)\n\n\n# not numeric\n(clean_fuels\n    .select(~cs.numeric())\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=13}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (6_402, 3)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th></tr><tr><td>str</td><td>str</td><td>str</td></tr></thead><tbody><tr><td>&quot;Africa&quot;</td><td>&quot;SSD&quot;</td><td>&quot;South Sudan&quot;</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;NIU&quot;</td><td>&quot;Niue&quot;</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;TKL&quot;</td><td>&quot;Tokelau&quot;</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;COK&quot;</td><td>&quot;Cook Islands&quot;</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;PLW&quot;</td><td>&quot;Palau&quot;</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;AUT&quot;</td><td>&quot;Austria&quot;</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;DEU&quot;</td><td>&quot;Germany&quot;</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;SWE&quot;</td><td>&quot;Sweden&quot;</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;PRT&quot;</td><td>&quot;Portugal&quot;</td></tr><tr><td>&quot;South-East Asia&quot;</td><td>&quot;IND&quot;</td><td>&quot;India&quot;</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\n## Filter\n\nExpressions show up really handy when we need to perform some operations. Logical operation are perhaps among the simplest operations one can think of. For example, we can compare every value in the column `region` with the string \"Europe\" and, if there's a match, return `True`, otherwise return `False`. If we now use this vector of logical values as the filter, all the records for which the value `True` is returned by this operation, will be included in the filtered dataset. \n\nHere's the subset of our original clean fuels data for Europe.\n\n::: {#ef3a5af2 .cell execution_count=14}\n``` {.python .cell-code}\n# large countries\n(clean_fuels\n    .filter(pl.col(\"region\")==\"Europe\")\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=14}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (1_749, 6)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th><th>year</th><th>pop_clean_fuels_cooking_mln</th><th>prop_clean_fuels_cooking_pct</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td><td>f64</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Europe&quot;</td><td>&quot;SMR&quot;</td><td>&quot;San Marino&quot;</td><td>2022</td><td>0.034</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;MCO&quot;</td><td>&quot;Monaco&quot;</td><td>2022</td><td>0.04</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;FRO&quot;</td><td>&quot;Faroe Islands&quot;</td><td>2022</td><td>0.05</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;AND&quot;</td><td>&quot;Andorra&quot;</td><td>2022</td><td>0.077</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;ISL&quot;</td><td>&quot;Iceland&quot;</td><td>2022</td><td>0.35</td><td>100.0</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BLR&quot;</td><td>&quot;Belarus&quot;</td><td>1990</td><td>7.48</td><td>73.2</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;AUT&quot;</td><td>&quot;Austria&quot;</td><td>1990</td><td>7.72</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;DEU&quot;</td><td>&quot;Germany&quot;</td><td>1990</td><td>79.12</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;SWE&quot;</td><td>&quot;Sweden&quot;</td><td>1990</td><td>8.57</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;PRT&quot;</td><td>&quot;Portugal&quot;</td><td>1990</td><td>9.95</td><td>100.0</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nYou can subset the data further by adding more expressions. Let's for example see if in the modern times there are still countries in Europe where the majority of people lack access to clean fuel for cooking.\n\n::: {#545a4685 .cell execution_count=15}\n``` {.python .cell-code}\n(clean_fuels\n    .filter(\n        pl.col(\"region\")==\"Europe\",\n        pl.col(\"year\")==2022,\n        pl.col(\"prop_clean_fuels_cooking_pct\")<50\n        )\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=15}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (1, 6)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th><th>year</th><th>pop_clean_fuels_cooking_mln</th><th>prop_clean_fuels_cooking_pct</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td><td>f64</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2022</td><td>1.43</td><td>41.1</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nOh, wow! Over half of population of Bosnia still does not have access to clearn fuels for cooking. Lets zoom in on Bosnia and try to visualize the data. \n\n::: {#06a46702 .cell execution_count=16}\n``` {.python .cell-code}\n(\nclean_fuels\n    .filter(pl.col(\"country_code\")==\"BIH\")\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=16}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (33, 6)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th><th>year</th><th>pop_clean_fuels_cooking_mln</th><th>prop_clean_fuels_cooking_pct</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td><td>f64</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2022</td><td>1.43</td><td>41.1</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2021</td><td>1.43</td><td>40.9</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2020</td><td>1.43</td><td>40.85</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2019</td><td>1.47</td><td>42.05</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2018</td><td>1.43</td><td>40.8</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>1994</td><td>2.29</td><td>58.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>1993</td><td>2.41</td><td>58.9</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>1992</td><td>2.47</td><td>58.25</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>1991</td><td>2.6</td><td>59.5</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>1990</td><td>2.64</td><td>59.2</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nWe are interested in how the population with access to clean fuels for cooking has developed over the years, so we place year on x axis and population on y axis. \n\n::: {#363d6569 .cell execution_count=17}\n``` {.python .cell-code}\n(\nggplot(<DATA>) +\n    geom_line(mapping=aes(x=\"year\", y=\"pop_clean_fuels_cooking_mln\"))\n)\n```\n:::\n\n\nAs you remember in plotnine the data should go into the first argument of gpplot function. One approach could be to copy the code for subsetting the code for subsetting the clean fuels dataframe into the `<DATA>` slot inside gpplot function\n\n::: {#e555ff90 .cell execution_count=18}\n``` {.python .cell-code}\n(\nggplot(\n    clean_fuels\n        .filter(pl.col(\"country_code\")==\"BIH\")\n    ) +\n    geom_line(mapping=aes(x=\"year\", y=\"prop_clean_fuels_cooking_pct\"))\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](wrangling_files/figure-html/cell-19-output-1.png){width=672 height=480}\n:::\n:::\n\n\nThis code works, but it is somewhat less clear whats going on. A cleaner alternative is by using `.pipe()` which passess the polars dataframe into the function provided as an argument. In this case our data about bosnian households will be passed as a first argument into the ggplot function, which is what we wanted all along. All code after .pipe(ggplot) is plotnine code, hence the use of +\n\n::: {#ec6f65ff .cell execution_count=19}\n``` {.python .cell-code}\n(clean_fuels\n    .filter(pl.col(\"country_code\")==\"BIH\")\n    .pipe(ggplot) +\n    geom_line(mapping=aes(x=\"year\", y=\"pop_clean_fuels_cooking_mln\"))\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](wrangling_files/figure-html/cell-20-output-1.png){width=672 height=480}\n:::\n:::\n\n\n::: {#86e9db1e .cell execution_count=20}\n``` {.python .cell-code}\n# str.contains, str.starts_with, str.ends_with, str.extract, .str.replace, .str.replace_all\n```\n:::\n\n\n# mutating(with_columns)\n\nLets practice what we learned about filtering by visualizing causes of death in some European countries. First of all, note that our household air pollution deaths dataset contains both summaries and breakdowns of deaths for every country and year. The observation where `cause_of_death` is indicated as \"All causes\" is a sum of all the other lines for that country and year.\n\n::: {#4d8876cd .cell execution_count=21}\n``` {.python .cell-code}\n(hhap_deaths\n    .filter(pl.col(\"country_code\")==\"BIH\", pl.col(\"year\")==2010)\n    )\n```\n\n::: {.cell-output .cell-output-display execution_count=20}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (6, 6)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th><th>year</th><th>cause_of_death</th><th>deaths</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td><td>str</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2010</td><td>&quot;Acute lower respiratory infect…</td><td>147.2</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2010</td><td>&quot;Stroke&quot;</td><td>1685.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2010</td><td>&quot;Ischaemic heart disease&quot;</td><td>2067.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2010</td><td>&quot;Chronic obstructive pulmonary …</td><td>365.2</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2010</td><td>&quot;All causes&quot;</td><td>4816.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;BIH&quot;</td><td>&quot;Bosnia and Herzegovina&quot;</td><td>2010</td><td>&quot;Trachea, bronchus, lung cancer…</td><td>551.7</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nWe might need to remove this line if we want to avoid double counting the deaths in each country. Lets look at European countries for which we have data on the number of deaths.\n\n::: {#194ccb4e .cell execution_count=22}\n``` {.python .cell-code}\n(hhap_deaths\n    .filter(pl.col(\"region\")==\"Europe\",\n            pl.col(\"deaths\")>0,\n            pl.col(\"cause_of_death\")!=\"All causes\")\n    .pipe(ggplot)+\n    aes(x=\"year\", y=\"deaths\", color=\"cause_of_death\", group=\"cause_of_death\")+\n    geom_smooth(method=\"lm\")+\n    facet_wrap(\"country\", scales=\"free_y\", ncol=9)+\n    theme(figure_size=(20,10), legend_position=\"bottom\")\n    )\n```\n\n::: {.cell-output .cell-output-display}\n![](wrangling_files/figure-html/cell-23-output-1.png){width=1920 height=960}\n:::\n:::\n\n\nIt would be really nice to put these numbers in perspective of population in each country. How can we get the population numbers? We could calculate it from the data on clean fuels data. Let's see how we could do that\n\n::: {#d68e0529 .cell execution_count=23}\n``` {.python .cell-code}\n(clean_fuels)\n```\n\n::: {.cell-output .cell-output-display execution_count=22}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (6_402, 6)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th><th>year</th><th>pop_clean_fuels_cooking_mln</th><th>prop_clean_fuels_cooking_pct</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td><td>f64</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Africa&quot;</td><td>&quot;SSD&quot;</td><td>&quot;South Sudan&quot;</td><td>2022</td><td>0.0</td><td>0.0</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;NIU&quot;</td><td>&quot;Niue&quot;</td><td>2022</td><td>0.002</td><td>98.5</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;TKL&quot;</td><td>&quot;Tokelau&quot;</td><td>2022</td><td>0.0004</td><td>28.3</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;COK&quot;</td><td>&quot;Cook Islands&quot;</td><td>2022</td><td>0.013</td><td>72.7</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;PLW&quot;</td><td>&quot;Palau&quot;</td><td>2022</td><td>0.007</td><td>29.45</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;AUT&quot;</td><td>&quot;Austria&quot;</td><td>1990</td><td>7.72</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;DEU&quot;</td><td>&quot;Germany&quot;</td><td>1990</td><td>79.12</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;SWE&quot;</td><td>&quot;Sweden&quot;</td><td>1990</td><td>8.57</td><td>100.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;PRT&quot;</td><td>&quot;Portugal&quot;</td><td>1990</td><td>9.95</td><td>100.0</td></tr><tr><td>&quot;South-East Asia&quot;</td><td>&quot;IND&quot;</td><td>&quot;India&quot;</td><td>1990</td><td>96.58</td><td>11.1</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nNew columns can be created using `with_columns()` expression evaluation environment. Here expressions can be included which will produce new columns to be added to the dataset. First of all we are interested in turning the percentage of people with access to clean fuels into the true proportion by dividing it by 100. Note that if we name the expression by including the string value in front of = sign, this value will be used as a new column name. \n\n::: {#a4050779 .cell execution_count=24}\n``` {.python .cell-code}\n(clean_fuels\n    .with_columns(prop=pl.col(\"prop_clean_fuels_cooking_pct\")/100)\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=23}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (6_402, 7)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th><th>year</th><th>pop_clean_fuels_cooking_mln</th><th>prop_clean_fuels_cooking_pct</th><th>prop</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td><td>f64</td><td>f64</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Africa&quot;</td><td>&quot;SSD&quot;</td><td>&quot;South Sudan&quot;</td><td>2022</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;NIU&quot;</td><td>&quot;Niue&quot;</td><td>2022</td><td>0.002</td><td>98.5</td><td>0.985</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;TKL&quot;</td><td>&quot;Tokelau&quot;</td><td>2022</td><td>0.0004</td><td>28.3</td><td>0.283</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;COK&quot;</td><td>&quot;Cook Islands&quot;</td><td>2022</td><td>0.013</td><td>72.7</td><td>0.727</td></tr><tr><td>&quot;Western Pacific&quot;</td><td>&quot;PLW&quot;</td><td>&quot;Palau&quot;</td><td>2022</td><td>0.007</td><td>29.45</td><td>0.2945</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;AUT&quot;</td><td>&quot;Austria&quot;</td><td>1990</td><td>7.72</td><td>100.0</td><td>1.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;DEU&quot;</td><td>&quot;Germany&quot;</td><td>1990</td><td>79.12</td><td>100.0</td><td>1.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;SWE&quot;</td><td>&quot;Sweden&quot;</td><td>1990</td><td>8.57</td><td>100.0</td><td>1.0</td></tr><tr><td>&quot;Europe&quot;</td><td>&quot;PRT&quot;</td><td>&quot;Portugal&quot;</td><td>1990</td><td>9.95</td><td>100.0</td><td>1.0</td></tr><tr><td>&quot;South-East Asia&quot;</td><td>&quot;IND&quot;</td><td>&quot;India&quot;</td><td>1990</td><td>96.58</td><td>11.1</td><td>0.111</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nNow we can use the newly created column in a new with_columns statement. Here I divided the population with access to clean fuels by the proportion to arrive at the annual estimate of population.  I wrapped the whole expression into parenthesis (to make sure that the division operator is properly handled) and passed the result to alias() which specifies the name for the expression, which will be used as a column name. This looks good. Lets assign it to a variable.\n\n::: {#acf67c7e .cell execution_count=25}\n``` {.python .cell-code}\n(clean_fuels\n    .with_columns(prop=pl.col(\"prop_clean_fuels_cooking_pct\")/100)\n    .with_columns((pl.col(\"pop_clean_fuels_cooking_mln\")/pl.col(\"prop\")).alias(\"population\"))\n)\n\nclean_fuels_pop_df = (clean_fuels\n    .with_columns((pl.col(\"pop_clean_fuels_cooking_mln\")/\n                    (pl.col(\"prop_clean_fuels_cooking_pct\")/100)).alias(\"population\"))\n)\n\n# note that we created NaNs \nclean_fuels_pop_df.describe()\n```\n\n::: {.cell-output .cell-output-display execution_count=24}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (9, 8)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>statistic</th><th>region</th><th>country_code</th><th>country</th><th>year</th><th>pop_clean_fuels_cooking_mln</th><th>prop_clean_fuels_cooking_pct</th><th>population</th></tr><tr><td>str</td><td>str</td><td>str</td><td>str</td><td>f64</td><td>f64</td><td>f64</td><td>f64</td></tr></thead><tbody><tr><td>&quot;count&quot;</td><td>&quot;6402&quot;</td><td>&quot;6402&quot;</td><td>&quot;6402&quot;</td><td>6402.0</td><td>6402.0</td><td>6402.0</td><td>6402.0</td></tr><tr><td>&quot;null_count&quot;</td><td>&quot;0&quot;</td><td>&quot;0&quot;</td><td>&quot;0&quot;</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.0</td></tr><tr><td>&quot;mean&quot;</td><td>null</td><td>null</td><td>null</td><td>2006.0</td><td>19.29797</td><td>61.080069</td><td>NaN</td></tr><tr><td>&quot;std&quot;</td><td>null</td><td>null</td><td>null</td><td>9.522648</td><td>73.100935</td><td>39.952764</td><td>NaN</td></tr><tr><td>&quot;min&quot;</td><td>&quot;Africa&quot;</td><td>&quot;AFG&quot;</td><td>&quot;Afghanistan&quot;</td><td>1990.0</td><td>0.0</td><td>0.0</td><td>0.001112</td></tr><tr><td>&quot;25%&quot;</td><td>null</td><td>null</td><td>null</td><td>1998.0</td><td>0.23</td><td>16.6</td><td>1.305556</td></tr><tr><td>&quot;50%&quot;</td><td>null</td><td>null</td><td>null</td><td>2006.0</td><td>2.24</td><td>78.0</td><td>6.833333</td></tr><tr><td>&quot;75%&quot;</td><td>null</td><td>null</td><td>null</td><td>2014.0</td><td>10.24</td><td>100.0</td><td>22.727273</td></tr><tr><td>&quot;max&quot;</td><td>&quot;Western Pacific&quot;</td><td>&quot;ZWE&quot;</td><td>&quot;Zimbabwe&quot;</td><td>2022.0</td><td>1257.0</td><td>100.0</td><td>1431.66287</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nThere are a few `NaN` values in our data. Let's see what those are.\n\n::: {#f7bf7026 .cell execution_count=26}\n``` {.python .cell-code}\n(clean_fuels_pop_df\n    .filter(pl.col(\"population\").is_nan()))\n```\n\n::: {.cell-output .cell-output-display execution_count=25}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (35, 7)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>country_code</th><th>country</th><th>year</th><th>pop_clean_fuels_cooking_mln</th><th>prop_clean_fuels_cooking_pct</th><th>population</th></tr><tr><td>str</td><td>str</td><td>str</td><td>i64</td><td>f64</td><td>f64</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Africa&quot;</td><td>&quot;SSD&quot;</td><td>&quot;South Sudan&quot;</td><td>2022</td><td>0.0</td><td>0.0</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;SSD&quot;</td><td>&quot;South Sudan&quot;</td><td>2021</td><td>0.0</td><td>0.0</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;SSD&quot;</td><td>&quot;South Sudan&quot;</td><td>2020</td><td>0.0</td><td>0.0</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;SSD&quot;</td><td>&quot;South Sudan&quot;</td><td>2019</td><td>0.0</td><td>0.0</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;SSD&quot;</td><td>&quot;South Sudan&quot;</td><td>2018</td><td>0.0</td><td>0.0</td><td>NaN</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;BEN&quot;</td><td>&quot;Benin&quot;</td><td>1991</td><td>0.0</td><td>0.0</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;SLE&quot;</td><td>&quot;Sierra Leone&quot;</td><td>1991</td><td>0.0</td><td>0.0</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;TGO&quot;</td><td>&quot;Togo&quot;</td><td>1990</td><td>0.0</td><td>0.0</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;BEN&quot;</td><td>&quot;Benin&quot;</td><td>1990</td><td>0.0</td><td>0.0</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>&quot;SLE&quot;</td><td>&quot;Sierra Leone&quot;</td><td>1990</td><td>0.0</td><td>0.0</td><td>NaN</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nIn the instances where the proportion was zero, we have obtained NaN instead of the proper population estimate. NaNs being one kind missing values propagate in calculations. This is why in the quantitative summaries we see that mean and standard deviation are also NaN for population column.\n\nPerhaps better source of population data could be the `fuel_types` dataset.\n\n::: {#51895bc6 .cell execution_count=27}\n``` {.python .cell-code}\nfuel_types_pop_df = (fuel_types\n    .with_columns(population=pl.col(\"pop_cooking_mln\")/pl.col(\"prop_cooking_pct\")*100)\n)\n```\n:::\n\n\nThis looks promising. We still get many `NaN` values, but now we also get multiple estimates of population from every fuel type for every country and every year. The difference in these estimates comes from the rounding imprecision in proportion of population with access to the particular fuel type. It would be really nice to be able level out those immaterial differences, through, for example, averaging.\n\n\n# summarizing (group_by, agg)\n\nOne of the most important operations data analysts do is producing various summaries of the data. Often we are interested in some sort of summary of the data by group. In our newly produced dataset, we could interested in total population for all countries in each of the regions. In polar we do it in two steps: first specify the groups using group_by() and then aggregate the data using .agg().\n\n::: {#5643d4ea .cell execution_count=28}\n``` {.python .cell-code}\n(fuel_types_pop_df\n    .group_by(\"region\",\"year\", \"country\")\n    .agg(pl.col(\"population\").mean())\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=27}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (5_313, 4)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>year</th><th>country</th><th>population</th></tr><tr><td>str</td><td>i64</td><td>str</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Western Pacific&quot;</td><td>1995</td><td>&quot;Marshall Islands&quot;</td><td>NaN</td></tr><tr><td>&quot;Americas&quot;</td><td>1994</td><td>&quot;Dominica&quot;</td><td>NaN</td></tr><tr><td>&quot;Americas&quot;</td><td>1990</td><td>&quot;Colombia&quot;</td><td>NaN</td></tr><tr><td>&quot;Europe&quot;</td><td>2007</td><td>&quot;Turkmenistan&quot;</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>2007</td><td>&quot;Sierra Leone&quot;</td><td>NaN</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Eastern Mediterranean&quot;</td><td>2002</td><td>&quot;Pakistan&quot;</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>1998</td><td>&quot;Liberia&quot;</td><td>2.636587</td></tr><tr><td>&quot;Africa&quot;</td><td>2012</td><td>&quot;Liberia&quot;</td><td>NaN</td></tr><tr><td>&quot;Europe&quot;</td><td>2004</td><td>&quot;Greece&quot;</td><td>NaN</td></tr><tr><td>&quot;Americas&quot;</td><td>2011</td><td>&quot;Ecuador&quot;</td><td>NaN</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nThis is nice, but population in some years seem to show as NaN. This is because of division by zero in the previous section. We can drop these values before summarizing with `.drop_nans()`. Alternatively, we could drop the zero-valued records (`drop_nulls()`) in the \"proportion of population with access to clean fuels\", which is used in the denominator of our `population` column\n\nLets group by year and region and repeat (removing the missing values). and plot the result\n\n::: {#72c6bbaf .cell execution_count=29}\n``` {.python .cell-code}\n(fuel_types_pop_df\n    .group_by(\"region\", \"year\", \"country\")\n    .agg(pl.col(\"population\").drop_nans().mean()) \n    .group_by(\"region\", \"year\")\n    .agg(pl.col(\"population\").mean())\n    .pipe(ggplot)\n    +geom_line(aes(x=\"year\", y=\"population\", color=\"region\"))\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](wrangling_files/figure-html/cell-30-output-1.png){width=672 height=480}\n:::\n:::\n\n\nAs expected, we observe rapid grown in population of Africa and South-East Asia, while European population growth has stagnated.\n\nExpression can be started from one of the summary functions, with the column name as an argument. Compare two ways of expressing the same thing:\n\n::: {#8933af67 .cell execution_count=30}\n``` {.python .cell-code}\n(fuel_types_pop_df\n    .group_by(\"region\", \"year\", \"country\")\n    .agg(pl.col(\"population\").drop_nans().mean().alias(\"mean_pop_fuel_types\")) )\n\n(fuel_types_pop_df\n    .group_by(\"region\", \"year\", \"country\")\n    .agg(pl.mean(\"population\").alias(\"mean_pop_fuel_types\")) )\n```\n\n::: {.cell-output .cell-output-display execution_count=29}\n```{=html}\n<div><style>\n.dataframe > thead > tr,\n.dataframe > tbody > tr {\n  text-align: right;\n  white-space: pre-wrap;\n}\n</style>\n<small>shape: (5_313, 4)</small><table border=\"1\" class=\"dataframe\"><thead><tr><th>region</th><th>year</th><th>country</th><th>mean_pop_fuel_types</th></tr><tr><td>str</td><td>i64</td><td>str</td><td>f64</td></tr></thead><tbody><tr><td>&quot;Africa&quot;</td><td>2014</td><td>&quot;Mauritius&quot;</td><td>NaN</td></tr><tr><td>&quot;South-East Asia&quot;</td><td>2005</td><td>&quot;Myanmar&quot;</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>2004</td><td>&quot;Mozambique&quot;</td><td>20.189321</td></tr><tr><td>&quot;Americas&quot;</td><td>2013</td><td>&quot;Antigua and Barbuda&quot;</td><td>NaN</td></tr><tr><td>&quot;South-East Asia&quot;</td><td>2006</td><td>&quot;Bangladesh&quot;</td><td>NaN</td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr><tr><td>&quot;Europe&quot;</td><td>2006</td><td>&quot;Albania&quot;</td><td>NaN</td></tr><tr><td>&quot;Americas&quot;</td><td>1994</td><td>&quot;Dominica&quot;</td><td>NaN</td></tr><tr><td>&quot;Africa&quot;</td><td>1994</td><td>&quot;Congo&quot;</td><td>2.725126</td></tr><tr><td>&quot;Americas&quot;</td><td>1990</td><td>&quot;Panama&quot;</td><td>NaN</td></tr><tr><td>&quot;Americas&quot;</td><td>1997</td><td>&quot;Costa Rica&quot;</td><td>NaN</td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nSometimes you dont want to summarize, but rather perform operation per group. Lets start by plotting total population per region for each fuel type over time. We want to group the data by region, year and fuel type and sum over countries. We can use faceted lineplot to see what's going on in each continent clearly. The range of values is quite large. We can use log scale to deal with this.\n\n::: {#3240ecd1 .cell execution_count=31}\n``` {.python .cell-code}\n(\n    fuel_types\n    .group_by(\"fuel_type\", \"year\", \"region\")\n    .agg(pl.col(\"pop_cooking_mln\").sum())\n    .pipe(ggplot)\n    +geom_line(aes(x=\"year\", y=\"pop_cooking_mln\", color=\"fuel_type\", group=\"fuel_type\"))\n    +facet_wrap(\"region\", ncol=3)\n    +scale_y_log10()\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](wrangling_files/figure-html/cell-32-output-1.png){width=672 height=480}\n:::\n:::\n\n\nThis looks good. We have quite different stories per continent: transitioning away from coal and charcoal in Europe and Americas. Rising importance of electricity and gas across the flobe and quite important role of biomass in Africa and South-East Asia.\n\nHowever because the population of these subgroups is so different it's hard to see the energy mix in every continent clearly. Can we represent the share of population relying on each type of fuel per continent?\n\nWhat we need to do is divide these numbers by totals across all fuel types. We start with the code we have so far and add one more variable: proportion of population. Here we take the summed up `pop_cooking_mln` (which after aggregation contains total per region, year and fuel type) and divide it by the sum of the values across fuel type. This is not aggregation, because we dont collapse the number of observations. We just want calulate sums over certain subgroups. In polars this is expressed with the method .over(), which takes the names of the grouping variables over which expression shall be computed. Think of this as adding variables per group. We write out our expression `pop_cooking_mln`) divided by the sum of the same column, but the sum should be calcualated not for all dataset, but rather per year and region, effectively summing across the fuel type, which is the remaining variable not included in the over() statement.\n\n::: {#b8ac7aa1 .cell execution_count=32}\n``` {.python .cell-code}\n(\n    fuel_types\n    .group_by(\"fuel_type\", \"year\", \"region\")\n    .agg(pl.col(\"pop_cooking_mln\").sum())\n    .with_columns(prop_pop=(pl.col(\"pop_cooking_mln\")/pl.col(\"pop_cooking_mln\").sum())\n                            .over(\"year\", \"region\"))\n    .pipe(ggplot)\n    +geom_area(aes(x=\"year\", y=\"prop_pop\", fill=\"fuel_type\"))\n    +facet_wrap(\"region\", ncol=3)\n    +scale_fill_cmap_d()\n    +theme_linedraw()\n    +labs(title=\"Energy mix per world region\",\n        subtitle=\"From biomass to natural gas\",\n        y=\"Share of population\", x=\"Year\", fill=\"Fuel Type\")\n)\n```\n\n::: {.cell-output .cell-output-display}\n![](wrangling_files/figure-html/cell-33-output-1.png){width=672 height=480}\n:::\n:::\n\n\n::: {#75daa4ad .cell execution_count=33}\n``` {.python .cell-code}\n#\n# When the categories are known up front use Enum. When you don't know the categories or they are not fixed then you use Categorical\n\n# fill_null(strategy=)\n# fill_nan()\n```\n:::\n\n\n",
    "supporting": [
      "wrangling_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}